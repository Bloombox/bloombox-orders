<link rel="import" href="../polymer/polymer.html">


<dom-module id="bloombox-orders">
  <template>
    <style>
      :host {
        display: block;
      }

      :host > div {
        margin-bottom: -5px;
      }

      :host a {
        text-decoration: none;
      }

      ul {
        padding: 0 0 1em 0;
        margin: 0;
      }

      .btn {
        border: 0;
        border-radius: 4px;
        padding: 0.5em 0.75em;
        color: #fff;
        font-size: 1em;
        float: right;
      }

      .btn.approve {
        background: blue;

      }

      .btn.reject {
        background: red;
        margin-right: 1em;
      }

      h2.text-title {
        margin-bottom: 1em;
      }

      .text-title {
        font-size: 1.2em;
        margin-bottom: 0.2em;
        text-decoration: underline;
      }

      .orders {
        margin-bottom: 1em;
        list-style: none;
        border-top: 2px solid #ccc;
        padding-top: 0.5em;
      }

      .orders li {
       border-bottom: 2px solid #ccc;
       margin-bottom: 0.5em;
       padding-bottom: 0.5em;
       text-align: center;
     }

     .instructions {
      line-height: 1.3;
     }

     :host h2 {
      font-size: 1.1em;
      text-align: center;
    }
  </style>
  <h2 class="text-title">Order [[data.orderKey]]</h2>
  <div class="text-title"><strong>Customer Information</strong></div>
  <div>[[data.customer.name.firstName]] [[data.customer.name.lastName]]</div>
  <div><a href="tel:[[data.customer.phone]]">[[_phoneFormatter(data.customer.phone)]]</a></div>
  <div><a href="mailto:[[data.customer.email]]">[[data.customer.email]]</a></div>
  <div>Rec ID: [[data.customer.foreignId]]</div>

  <br>

  <div class="text-title"><strong>Order Details</strong></div>
  <div><strong>Status:</strong> {{_capitalize(data.status)}}</div>
  <div><strong>Type:</strong> [[_capitalize(data.type)]]</div>
  <div><strong>Schedule: </strong> [[_getSchedule(data)]]</div>

  <br>
 
  <template is="dom-if" if="[[_isDelivery(data.type)]]">
    <div class="text-title"><strong>Delivery Location:</strong></div>
    <div>[[data.destination.firstLine]] [[data.destination.secondLine]]</div>
    <div>[[data.destination.city]], [[data.destination.state]] [[data.destination.zipcode]]</div>

    <template is="dom-if" if="[[_exists(data.destination.deliveryInstructions)]]">
      <br>
      <div class="text-title"><strong>Instructions:</strong></div>
      <div class="instructions">{{data.destination.deliveryInstructions}}</div>
    </template>
  </template>
  <h2>Items:</h2>

  <ul class="orders">
    <template is="dom-repeat" items="[[data.productsInOrder]]">
      <li><strong>[[_getItemCount(index)]]x [[_getVariant(index, 'weight')]]</strong> [[item.name]]</li>
    </template>
  </ul>

  <button class="btn approve" on-tap="_approveOrder">
    Approve
  </button>

  <button class="btn reject" on-tap="_rejectOrder">
   Reject
 </button>

</template>

<script>
    /**
     * `bloombox-orders`
     * Orders view container
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
     var BloomboxOrders = Polymer.BloomboxOrders = Polymer({
      is: "bloombox-orders",
      properties: {
        data: {
          type: Object,
          notify: true,
          observer: '_viewBinded'
        }
      },
      _approveOrder: function() {
        console.log('approving order')
        this.data.status = 'APPROVED'
        this._updateFbValues()
      },
      _rejectOrder: function() {
        console.log('rejecting order')
        this.data.status = 'REJECTED'
        this._updateFbValues()
      },
      _updateFbValues: function() {
        // DONT FORGET TO FUCKING FIX THIS
        var db = firebase.database().ref(this.endpoint + '/locations/' + this.location + '/orders/' + this.data.orderKey + '/status')
        db.set(this.data.status)
        this.set('data.status', this.data.status)
      },
      _exists: function(check) {
        return check !== "";
      },
      _getSchedule(data) {
        if(data.scheduling.scheduling === "ASAP") {
          return "ASAP";
        } else {
          return new Date(data.createdAt.time * 1000);
        }
      },
      _isDelivery: function(type) {
        return type === "DELIVERY"
      },
      _getVariant: function(index, property) {
        var self = this;
        if(self.data.items[index].variant[0][property] !== 'NO_WEIGHT')
          return self._capitalize(self.data.items[index].variant[0][property])
      },
      _capitalize(text) {
        return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
      },
      _getItemCount: function(index) {
        return this.data.items[index].count
      },
      _phoneFormatter: function(s) {
        return s.slice(0, 2) + ' (' + s.slice(2, 5) + ') ' + s.slice(5, 8) + '-' + s.slice(8, 12);
      },  
      _viewBinded: function() {

      }
    });
  </script>
</dom-module>
